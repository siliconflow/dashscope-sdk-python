需要以generational顶尖计算机理论科学家的严谨，
归纳和总结当前所有设计要点

## 兼容模式
将
create_mock_server，
create_app，
run_server，
这几个接口，
MockServer这个类，
保留作为测试的兼容入口，
需要把这几个接口和类暴露出去，
但仍然有 main 作为部署入口

## 设计准则
- 接口兼容性层 (Adapter Layer): 通过 Pydantic 模型严格定义 DashScope 和 OpenAI 的数据结构，实现了从“历史遗留格式”到“现代 Chat Completion 格式”的无损转换。
- 流式状态机 (Streaming State Machine): DeepSeek R1 的推理内容 (reasoning_content) 和 Token 使用量 (usage) 处理被封装在独立的生成器中，确保 SSE (Server-Sent Events) 协议的每一帧都符合 DashScope 规范。
- 在进入测试模式后，保留原有的硬编码 mock server 行为，确保现有测试用例不受影响。
- 需要有logger，从测试兼容模式启动时，需要进入debug模式，支持详细的请求和响应日志记录，需要不停地打印当前系统内on-the-fly的状态（有epoch时钟，打印现在有多少个请求在处理）。
- 我们必须严格遵守客户端的意愿。
  当 SDK 请求 incremental_output=True（流式）时 -> 走 SSE 通道（保留思维链支持）。
  当 SDK 请求普通模式（默认）时 -> 走标准 JSON 通道（关闭流式，防止 SDK 崩溃）。
- Request Queue 需要存储“扁平化”的 Payload，而非封装对象，以消除 KeyError。
- Response Queue 必须被 Proxy 主动消费，以实现“模拟优先”，消除内容不匹配的 AssertionError。
- Output Structure 必须同时包含 text 和 choices，以实现对遗留 SDK 代码的“向后兼容”。

## 注意避免这些错误
- TypeError: create_mock_server() takes 0 positional arguments but 1 was given
- AttributeError: 'FastAPI' object has no attribute 'responses'
- ImportError: cannot import name 'MockServer' from 'tests.mock_server' (/Users/tsai/oss/dashscope-sdk-python/tests/mock_server.py). Did you mean: 'mock_server'?

## 注意避免死锁
测试代码一直卡在 queue.get() 等待数据（Block），而服务器处理完请求后就没事干了。两边互相等待（或者单边永久等待），导致测试挂起。

## 使用的技术栈
使用python openai sdk

## 配置
需要有个模型mapping的函数作为开放接口，默认Qwen/Qwen3-8B，
以及
SILICON_FLOW_BASE_URL = "https://api.siliconflow.cn/v1"
SILICON_FLOW_API_KEY = os.getenv("SILICON_FLOW_API_KEY", "sk-your-siliconflow-key-here")
我在使用uv
我会直接copy-paste 到原来的tests/mock_server.py文件中再运行测试
